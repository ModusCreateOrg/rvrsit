/*

This file is part of Sencha Touch 2

Copyright (c) 2012 Sencha Inc

Contact:  http://www.sencha.com/contact

Commercial Usage
Licensees holding valid commercial licenses may use this file in accordance with the Commercial Software License Agreement provided with the Software or, alternatively, in accordance with the terms contained in a written agreement between you and Sencha.

If you are unsure which license is appropriate for your use, please contact the sales department at http://www.sencha.com/contact.

*/
(function(global){var PREFIX="blink-",emptyFn=function(){},callbacks=[],doc=global.document,head=doc.head,addWindowListener=global.addEventListener,storage=global.localStorage,appCache=global.applicationCache,a=doc.createElement("a"),documentLocation=doc.location,documentUri=documentLocation.origin+documentLocation.pathname+documentLocation.search,manifestFile="app.json",manifestKey=PREFIX+documentUri+"-"+manifestFile,base=head.querySelector("base");if(!base){base=document.createElement("base");head.appendChild(base)}if(typeof Ext==="undefined"){var Ext=global.Ext={}}function toAbsoluteUri(uri){a.href=uri;return a.href}function writeMeta(name,content){doc.write('<meta name="'+name+'" content="'+content+'">')}function request(uri,isShared,onSuccess){(isShared?requestIframe:requestXhr)(uri,onSuccess)}function requestXhr(uri,onSuccess,onFailure){var xhr=new XMLHttpRequest(),status;onFailure=onFailure||emptyFn;try{xhr.open("GET",uri,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){status=xhr.status;if(status==200||status==304||status==0){onSuccess(xhr.responseText)}else{onFailure()}}};xhr.send(null)}catch(e){onFailure()}}function requestIframe(uri,onSuccess){var iframe=doc.createElement("iframe");callbacks.push({iframe:iframe,callback:onSuccess});iframe.src=uri;iframe.style.cssText="width:0;height:0;border:0;position:absolute;z-index:-999;visibility:hidden";doc.body.appendChild(iframe)}function onMessage(e){var data=e.data,sourceWindow=e.source.window,i,ln,callback,iframe;for(i=0,ln=callbacks.length;i<ln;i++){callback=callbacks[i];iframe=callback.iframe;if(iframe.contentWindow===sourceWindow){callback.callback(data);doc.body.removeChild(iframe);callbacks.splice(i,1);return}}}function patch(content,delta){var output=[],chunk,i,ln;if(delta.length===0){return content}for(i=0,ln=delta.length;i<ln;i++){chunk=delta[i];if(typeof chunk==="number"){output.push(content.substring(chunk,chunk+delta[++i]))}else{output.push(chunk)}}return output.join("")}function log(message){if(typeof console!="undefined"){(console.error||console.log).call(console,message)}}function blink(options){var scripts=options.js||[],styleSheets=options.css||[],itemsCount=scripts.length+styleSheets.length,assetVersionMap={},updatedCallback;addWindowListener("message",onMessage,false);function processAsset(asset){if(typeof asset=="string"){asset={path:asset}}if(asset.shared){asset.version=asset.shared;asset.uri=asset.shared+asset.path}else{asset.uri=toAbsoluteUri(asset.path)}return asset}function process(assets,type){var ln=assets.length,i,asset;for(i=0;i<ln;i++){asset=assets[i];assets[i]=asset=processAsset(asset);asset.type=type;asset.index=i;asset.collection=assets;asset.ready=false;asset.evaluated=false;assetVersionMap[asset.path]=asset.version}for(i=0;i<ln;i++){load(assets[i])}}function load(asset){var content=retrieve(asset);if(content===null){request(asset.uri,asset.shared,function(content){store(asset,content);onItemReady(asset,content)})}else{onItemReady(asset,content)}}function retrieve(asset){return storage.getItem(PREFIX+asset.uri)}function store(asset,content){return storage.setItem(PREFIX+asset.uri,content)}function onItemReady(asset,content){var items=asset.collection,index=asset.index,ln=items.length,i;asset.ready=true;asset.content=content;for(i=index-1;i>=0;i--){asset=items[i];if(!asset.ready||!asset.evaluated){return}}for(i=index;i<ln;i++){asset=items[i];if(asset.ready){if(!asset.evaluated){evaluate(asset)}}else{return}}}function evaluate(asset){asset.evaluated=true;if(asset.type=="js"){try{eval(asset.content)}catch(e){log("Error evaluating "+asset.uri+" with message: "+e)}}else{var style=doc.createElement("style"),baseHref;style.type="text/css";style.textContent=asset.content;if("id" in asset){style.id=asset.id}if("disabled" in asset){style.disabled=asset.disabled}baseHref=base.href;base.href=asset.path.replace(/\/[^\/]*$/,"/");head.appendChild(style);base.href=baseHref}delete asset.content;if(--itemsCount==0){onReady()}}function onReady(){var updatingAssets=[],appCacheReady=false,appCacheIdle=false,onAppCacheIdle=function(){appCacheIdle=true},updatingCount,manifestContent;global.removeEventListener("message",onMessage,false);if(appCache.status==appCache.CHECKING||appCache.status==appCache.DOWNLOADING){appCache.onupdateready=function(){appCache.swapCache();appCacheReady=true;onAppCacheIdle()};appCache.onnoupdate=appCache.onobsolete=onAppCacheIdle}else{onAppCacheIdle()}function notifyUpdateIfAppCacheReady(){if(appCacheReady){notifyUpdate()}}function notifyUpdate(){updatedCallback=Ext.onUpdated||emptyFn;if("onSetup" in Ext){Ext.onSetup(updatedCallback)}else{updatedCallback()}}function doUpdate(){storage.setItem(manifestKey,manifestContent);updatingAssets.forEach(function(asset){store(asset,asset.content)});notifyUpdate()}function onUpdated(asset,content){asset.content=content;if(--updatingCount==0){if(appCacheIdle){doUpdate()}else{onAppCacheIdle=doUpdate}}}requestXhr(manifestFile,function(content){var manifest=JSON.parse(content),assets=manifest.js.concat(manifest.css);manifestContent=content;assets.forEach(function(asset){asset=processAsset(asset);if(asset.version!==assetVersionMap[asset.path]){updatingAssets.push(asset)}});updatingCount=updatingAssets.length;if(updatingCount==0){if(appCacheIdle){notifyUpdateIfAppCacheReady()}else{onAppCacheIdle=notifyUpdateIfAppCacheReady}return}updatingAssets.forEach(function(asset){var path=asset.path,oldVersion=assetVersionMap[path],uri=asset.uri,update=asset.update;function updateFull(){request(uri,asset.shared,function(content){onUpdated(asset,content)})}if(!oldVersion||!update||update!="delta"){updateFull()}else{requestXhr("deltas/"+path+"/"+oldVersion+".json",function(content){try{onUpdated(asset,patch(retrieve(asset),JSON.parse(content)))}catch(e){log("Malformed delta content received for "+asset.uri)}},updateFull)}})})}if(itemsCount==0){onReady();return}process(styleSheets,"css");process(scripts,"js")}Ext.blink=function(options){var manifest=storage.getItem(manifestKey);if(manifest){options=JSON.parse(manifest)}else{storage.setItem(manifestKey,JSON.stringify(options))}writeMeta("viewport","width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no");writeMeta("apple-mobile-web-app-capable","yes");writeMeta("apple-touch-fullscreen","yes");if(doc.readyState.match(/interactive|complete|loaded/)!==null){blink(options)}else{addWindowListener("DOMContentLoaded",function(){blink(options)},false)}}})(this);
